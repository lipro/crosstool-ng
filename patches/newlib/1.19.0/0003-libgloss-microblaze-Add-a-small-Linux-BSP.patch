From 44b2abfb0a901d73818f6dc03e7069035429ca7d Mon Sep 17 00:00:00 2001
From: Edgar E. Iglesias <edgar.iglesias@gmail.com>
Date: Sun, 21 Aug 2011 23:46:05 +0200
Subject: [PATCH 03/17] libgloss-microblaze: Add a small Linux BSP

Signed-off-by: Edgar E. Iglesias <edgar.iglesias@gmail.com>
---
 libgloss/microblaze/Makefile.in           |   20 +++++++++++-
 libgloss/microblaze/elf-gloss-linux.specs |   14 +++++++++
 libgloss/microblaze/linux-crt0.S          |   41 ++++++++++++++++++++++++++
 libgloss/microblaze/linux-inbyte.c        |    6 ++++
 libgloss/microblaze/linux-outbyte.c       |    4 ++
 libgloss/microblaze/linux-syscalls-wrap.c |    7 ++++
 libgloss/microblaze/linux-syscalls.S      |   45 +++++++++++++++++++++++++++++
 libgloss/microblaze/linux-syscalls.h      |   28 ++++++++++++++++++
 8 files changed, 163 insertions(+), 2 deletions(-)
 create mode 100644 libgloss/microblaze/elf-gloss-linux.specs
 create mode 100644 libgloss/microblaze/linux-crt0.S
 create mode 100644 libgloss/microblaze/linux-inbyte.c
 create mode 100644 libgloss/microblaze/linux-outbyte.c
 create mode 100644 libgloss/microblaze/linux-syscalls-wrap.c
 create mode 100644 libgloss/microblaze/linux-syscalls.S
 create mode 100644 libgloss/microblaze/linux-syscalls.h

diff --git a/libgloss/microblaze/Makefile.in b/libgloss/microblaze/Makefile.in
index 69c2e68..2b93be2 100644
--- a/libgloss/microblaze/Makefile.in
+++ b/libgloss/microblaze/Makefile.in
@@ -80,25 +80,37 @@ LIB = libgloss.a
 OBJS = sbrk.o timer.o _exception_handler.o _hw_exception_handler.o _interrupt_handler.o _program_clean.o _program_init.o xil_malloc.o xil_sbrk.o 
 SCRIPTS	= xilinx.ld
 
+# Tiny Linux BSP.
+LINUX_BSP     = libgloss-linux.a
+CRT          += linux-crt0.o
+LINUX_OBJS    = linux-syscalls.o linux-syscalls-wrap.o
+LINUX_OBJS   += linux-outbyte.o linux-inbyte.o
+LINUX_SCRIPTS = elf-gloss-linux.specs
+
 CPU = @CPU@
 
 #### Host specific Makefile fragment comes in here.
 @host_makefile_frag@
 
-all: ${CRT} ${LIB}
+all: ${CRT} ${LIB} ${LINUX_BSP}
 
-install: ${CRT} ${LIB}
+install: ${CRT} ${LIB} install-linux
 	@for crt in ${CRT}; do \
 	$(INSTALL_PROGRAM) $${crt} $(DESTDIR)$(tooldir)/lib${MULTISUBDIR}/$${crt}; \
 	done
 	$(INSTALL_PROGRAM) ${LIB} $(DESTDIR)$(tooldir)/lib${MULTISUBDIR}
 	$(INSTALL_PROGRAM) $(srcdir)/${SCRIPTS} $(DESTDIR)$(tooldir)/lib/
 
+install-linux: ${LINUX_BSP}
+	$(INSTALL_PROGRAM) ${LINUX_BSP} $(DESTDIR)$(tooldir)/lib${MULTISUBDIR}
+	set -e; for x in ${LINUX_SCRIPTS}; do ${INSTALL_DATA} ${srcdir}/${objtype}$$x $(DESTDIR)${tooldir}/lib${MULTISUBDIR}/$$x; done
+
 crt0.o:	crt0.S
 crt1.o:	crt1.S
 crt2.o:	crt2.S
 crt3.o:	crt3.S
 crt4.o:	crt4.S
+linux-crt0.o: linux-crt0.S
 crtinit.o: crtinit.S
 sim-crtinit.o: sim-crtinit.S
 sim-pgcrtinit.o: sim-pgcrtinit.S
@@ -113,6 +125,10 @@ ${LIB}:	${OBJS}
 	${AR} ${ARFLAGS} $@ ${OBJS}
 	${RANLIB} $@
 
+${LINUX_BSP}: ${LINUX_OBJS}
+	${AR} ${ARFLAGS} $@ ${LINUX_OBJS}
+	${RANLIB} $@
+
 .PHONY: info dvi doc install-info clean-info
 info doc dvi:
 install-info:
diff --git a/libgloss/microblaze/elf-gloss-linux.specs b/libgloss/microblaze/elf-gloss-linux.specs
new file mode 100644
index 0000000..a80505a
--- /dev/null
+++ b/libgloss/microblaze/elf-gloss-linux.specs
@@ -0,0 +1,14 @@
+%rename link old_link
+%rename lib libc
+
+*link:
+%(old_link) -defsym _TEXT_START_ADDR=0x100 -z max-page-size=4096 -z common-page-size=4096 --no-omagic
+
+*libgloss:
+-lgloss-linux
+
+*lib:
+-start-group -lgloss-linux -lxil -lc -lm -end-group
+
+*startfile:
+linux-crt0%O%s crti%O%s crtbegin%O%s
diff --git a/libgloss/microblaze/linux-crt0.S b/libgloss/microblaze/linux-crt0.S
new file mode 100644
index 0000000..39ce8a8
--- /dev/null
+++ b/libgloss/microblaze/linux-crt0.S
@@ -0,0 +1,41 @@
+/* linux-crt0 -- Startup routines for the Linux BSP.
+ *
+ * Copyright (c) 2011 Edgar E. Iglesias
+ *
+ * The authors hereby grant permission to use, copy, modify, distribute,
+ * and license this software and its documentation for any purpose, provided
+ * that existing copyright notices are retained in all copies and that this
+ * notice is included verbatim in any distributions. No written agreement,
+ * license, or royalty fee is required for any of the authorized uses.
+ * Modifications to this software may be copyrighted by their authors
+ * and need not follow the licensing terms described here, provided that
+ * the new terms are clearly indicated on the first page of each file where
+ * they apply.
+ */
+
+        .section .text
+        .globl _start
+        .ent _start
+        .type _start, @function
+_start:
+	la	r13, r0, _SDA_BASE_
+	la	r2, r0, _SDA2_BASE_
+
+	brlid	r15, __init
+	nop
+
+	lwi	r5, r1, 0
+	addik	r6, r1, 4
+
+	# Add argc * 4.
+	addk	r7, r5, r5
+	addk	r7, r7, r7
+
+	brlid	r15, main
+	# Now add 4 + r1 (i.e r6) in the delayslot.
+	addk	r7, r7, r6
+
+	brlid   r15, exit
+        addik   r5, r3, 0
+	.size _start, . - _start
+        .end _start
diff --git a/libgloss/microblaze/linux-inbyte.c b/libgloss/microblaze/linux-inbyte.c
new file mode 100644
index 0000000..58fdf19
--- /dev/null
+++ b/libgloss/microblaze/linux-inbyte.c
@@ -0,0 +1,6 @@
+int inbyte(void)
+{
+	char ch = 0;
+	read(0, &ch, 1);
+	return ch;
+}
diff --git a/libgloss/microblaze/linux-outbyte.c b/libgloss/microblaze/linux-outbyte.c
new file mode 100644
index 0000000..9d7bc48
--- /dev/null
+++ b/libgloss/microblaze/linux-outbyte.c
@@ -0,0 +1,4 @@
+void outbyte (unsigned char c)
+{
+	_write(1, &c, 1);
+}
diff --git a/libgloss/microblaze/linux-syscalls-wrap.c b/libgloss/microblaze/linux-syscalls-wrap.c
new file mode 100644
index 0000000..bccb016
--- /dev/null
+++ b/libgloss/microblaze/linux-syscalls-wrap.c
@@ -0,0 +1,7 @@
+#include <sys/types.h>
+#include <sys/stat.h>
+#include <fcntl.h>
+
+int isatty (int fd) {
+	return 1;
+}
diff --git a/libgloss/microblaze/linux-syscalls.S b/libgloss/microblaze/linux-syscalls.S
new file mode 100644
index 0000000..506de78
--- /dev/null
+++ b/libgloss/microblaze/linux-syscalls.S
@@ -0,0 +1,45 @@
+/* linux-syscalls - Syscall interface to microblaze linux
+ *
+ * Copyright (c) 2011 Edgar E. Iglesias
+ *
+ * The authors hereby grant permission to use, copy, modify, distribute,
+ * and license this software and its documentation for any purpose, provided
+ * that existing copyright notices are retained in all copies and that this
+ * notice is included verbatim in any distributions. No written agreement,
+ * license, or royalty fee is required for any of the authorized uses.
+ * Modifications to this software may be copyrighted by their authors
+ * and need not follow the licensing terms described here, provided that
+ * the new terms are clearly indicated on the first page of each file where
+ * they apply.
+ */
+
+#include "linux-syscalls.h"
+
+#define FUNC(name) .type name, %function; name:
+
+#define GLOBAL(name) .global name; FUNC(name)
+#define SIZE(name) .size name, .-name
+
+# define SYSCALL_BODY(name)		\
+	addik	r12, r0, SYS_ ## name;	\
+	brki    r14, 8;			\
+	rtsd	r15, 8;			\
+	nop;
+
+# define SYSCALL(name)			\
+        GLOBAL(_ ## name);		\
+	SYSCALL_BODY(name);		\
+        SIZE(_ ## name)
+
+SYSCALL(brk)
+SYSCALL(exit)
+SYSCALL(read)
+SYSCALL(write)
+SYSCALL(open)
+SYSCALL(close)
+SYSCALL(lseek)
+SYSCALL(fstat)
+SYSCALL(unlink)
+SYSCALL(getpid)
+SYSCALL(kill)
+SYSCALL(rt_sigaction)
diff --git a/libgloss/microblaze/linux-syscalls.h b/libgloss/microblaze/linux-syscalls.h
new file mode 100644
index 0000000..3bceca3
--- /dev/null
+++ b/libgloss/microblaze/linux-syscalls.h
@@ -0,0 +1,28 @@
+/** Linux system call interface for the MicroBlaze processor.
+ * Copyright (c) 2009 Edgar E. Iglesias.
+ *
+ * Permission to use, copy, modify, and distribute this software
+ * is freely granted, provided that this notice is preserved.
+ */
+
+#define SYS_exit	1
+#define SYS_fork	2
+#define SYS_read	3
+#define SYS_write	4
+#define SYS_open	5
+#define SYS_close	6
+#define SYS_waitpid	7
+#define SYS_creat	8
+#define SYS_link	9
+#define SYS_unlink	10
+#define SYS_execve	11
+#define SYS_chdir	12
+#define SYS_time	13
+
+#define SYS_lseek	19
+#define SYS_getpid	20
+#define SYS_kill	37
+#define SYS_brk		45
+#define SYS_fstat	108
+
+#define SYS_rt_sigaction  174
-- 
1.7.1

