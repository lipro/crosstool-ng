From 468987adf4e231a01a9ae190dfc87b1e9836618f Mon Sep 17 00:00:00 2001
From: David Holsgrove <david.holsgrove@petalogix.com>
Date: Tue, 24 Apr 2012 18:20:44 +1000
Subject: [PATCH 53/79] microblaze: Add TLS_NEEDS_GOT or -fPIC around setting the GOT

Signed-off-by: David Holsgrove <david.holsgrove@petalogix.com>
---
 gcc/config/microblaze/linux.h      |    3 +++
 gcc/config/microblaze/microblaze.c |    2 +-
 gcc/config/microblaze/microblaze.h |    6 ++++++
 3 files changed, 10 insertions(+), 1 deletions(-)

diff --git a/gcc/config/microblaze/linux.h b/gcc/config/microblaze/linux.h
index 07f908c..3593d27 100644
--- a/gcc/config/microblaze/linux.h
+++ b/gcc/config/microblaze/linux.h
@@ -22,6 +22,9 @@
 #undef TARGET_SUPPORTS_PIC
 #define TARGET_SUPPORTS_PIC 1
 
+#undef TLS_NEEDS_GOT
+#define TLS_NEEDS_GOT 1
+
 #define DYNAMIC_LINKER "/lib/ld.so.1"
 #undef  SUBTARGET_EXTRA_SPECS
 #define SUBTARGET_EXTRA_SPECS \
diff --git a/gcc/config/microblaze/microblaze.c b/gcc/config/microblaze/microblaze.c
index ad4096e..e3b30e9 100755
--- a/gcc/config/microblaze/microblaze.c
+++ b/gcc/config/microblaze/microblaze.c
@@ -2936,7 +2936,7 @@ microblaze_expand_prologue (void)
 
 #if 1
   /* REVISIT: For TLS we may need GOT even when pic is not enabled */
-  if (flag_pic == 2 && df_regs_ever_live_p (MB_ABI_PIC_ADDR_REGNUM))
+  if ((flag_pic == 2 || TLS_NEEDS_GOT ) && df_regs_ever_live_p (MB_ABI_PIC_ADDR_REGNUM))
 #endif
     {
       SET_REGNO (pic_offset_table_rtx, MB_ABI_PIC_ADDR_REGNUM);
diff --git a/gcc/config/microblaze/microblaze.h b/gcc/config/microblaze/microblaze.h
index 5764ea9..b4cb596 100755
--- a/gcc/config/microblaze/microblaze.h
+++ b/gcc/config/microblaze/microblaze.h
@@ -66,9 +66,15 @@ extern enum pipeline_type microblaze_pipe;
 /* Do we have SWAPB and SWAPH?  */
 #define TARGET_HAS_SWAP     (TARGET_REORDER && microblaze_has_swap)
 
+/* The default is to not need GOT for TLS.  */
+#define TLS_NEEDS_GOT 0
+
 /* The default is to not support PIC.  */
 #define TARGET_SUPPORTS_PIC 1
 
+/* The default is to not need GOT for TLS.  */
+#define TLS_NEEDS_GOT 0
+
 /* What is the default setting for -mcpu= . We set it to v4.00.a even though 
    we are actually ahead. This is safest version that has generate code 
    compatible for the original ISA */
-- 
1.7.1

